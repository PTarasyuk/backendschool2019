# Бэкенд-сервис Analyzer

Оригинал статьи на [habr.com](https://habr.com/ru/company/yandex/blog/499534/). [GitHub](https://github.com/alvassin/backendschool2019).

Сервис с REST API, анализирующий рынок для промо-акций. Пример решения вступительного испытания 2019г. в Школу бэкенд‑разработки Яндекса.

- [Техническое задание](specification.md)
- [Введение](intro.md)
- [Разработка](dev.md)
- [Тестирование](tests.md)
- [Сборка](building.md)
- [Непрерывная интеграция](ci.md)
- [Деплой](deploy.md)
- [Нагрузочное тестирование](load_testing.md)
- [Инструменты](tools.md)

## Файловая структура проекта

```text
.
├─ analyzer/ .............. Python-пакет с проектом
│  ├─ api/
|  |  ├─ handlers/ ........ Обработчики
|  |  ├─ __init__.py
|  |  ├─ __main.py ........ Утилита для запуска REST API
|  |  ├─ app.py ........... Описание aiohttp-приложения
|  |  ├─ middleware.py
|  |  ├─ payloads.py ...... Инструкции по упаковке body aiohttp-ответов
|  |  └─ schema.py ........ Схемы валидации запросов и ответов REST API
|  ├─ db/
|  |  ├─ alembic/ ......... Миграции и всё, что с ними связано
|  |  ├─ __init__.py 
|  |  ├─ __main__.py ...... Утилита для управления состоянием БД
|  |  └─ schema.py ........ Описание схемы БД
|  ├─ utils/ .............. Утилиты
|  └─ __init__.py
├─ deploy/ ................ Описание деплоя, Ansible
├─ tests/ ................. Тесты
├─ Dockerfile
├─ LICENSE ................ Лицензия
├─ MANIFEST.in ............ Описание статических файлов добавляемых в
|                           Python-пакет
├─ Makefile ............... Набор инструкций для автоматизации сборки
├─ README.md .............. Описание проекта, инструкции по запуску
├─ requirements.dev.txt ... Список зависимостей для разработки/тестирования
├─ requirements.txt ....... Список зависимостей для использования в продакшине
└─ setup.py ............... Описание Python-пакета
```

## Что еще можно сделать?

Профилирование приложения показало, что около четверти всего времени выполнения запросов уходит на сериализацию и десериализацию JSON: данных, отправляемых и получаемых из сервиса, достаточно много. Эти процессы можно существенно ускорить с помощью библиотеки [`orjson`](https://github.com/ijl/orjson), но сервис придется немного подготовить — `orjson` не является drop-in-заменой для стандартного модуля `json`.

Обычно для продакшена требуется несколько копий сервиса, чтобы обеспечить отказоустойчивость и справиться с нагрузкой. Для управления группой сервисов нужен инструмент, показывающий, «жива» ли копия сервиса. Решить эту задачу можно обработчиком `/health`, который опрашивает все требуемые для работы ресурсы, в нашем случае — базу данных. Если `SELECT 1` выполняется меньше чем за секунду, то сервис жив. Если нет — нужно обратить на него внимание.

Когда приложение очень интенсивно работает с сетью, [`uvloop`](https://github.com/MagicStack/uvloop) может здорово увеличить производительность.

Немаловажным фактором является и читабельность кода. Один мой коллега, Юрий Шиканов, написал объединяющий несколько инструментов модуль [`gray`](https://github.com/dizballanze/gray) для автоматической проверки и оформления кода, который легко добавить в `pre-commit` Git-хук, настроить одним файлом конфигурации или переменными окружения. Gray позволяет сортировать импорты ([`isort`](https://timothycrosley.github.io/isort/)), оптимизирует выражения python в соответствии с новыми версиями языка ([`pyupgrade`](https://github.com/asottile/pyupgrade)), добавляет запятые в конце вызовов функций, импортов, списков и т. д. ([`add-trailing-comma`](https://github.com/asottile/add-trailing-comma)), а также приводит кавычки к единому виду ([`unify`](https://github.com/myint/unify)).

## Благодарности

Я хотел бы выразить огромную благодарность ребятам, которые нашли время принять участие в написании этой статьи, поревьювить код, внести свои идеи и замечания:

* Марии Зеленовой [@zelma](https://habr.com/ru/users/zelma/),
* Владимиру Соломатину [@leenr](https://habr.com/ru/users/leenr/),
* Анастасии Семёновой [@morkov](https://habr.com/ru/users/morkov/),
* Юрию Шиканову [@dizballanze](https://habr.com/ru/users/dizballanze/),
* Михаилу Шушпанову [@mishush](https://habr.com/ru/users/mishush/),
* Павлу Мосеину [@pavkazzz](https://habr.com/ru/users/pavkazzz/),
* Дмитрию Орлову [@orlovdl](https://habr.com/ru/users/orlovdl/).
